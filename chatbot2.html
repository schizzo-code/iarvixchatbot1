<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Iarvix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            width: 100%;
            background: #f8fafc;
            position: relative;
            overflow-x: hidden;
        }

        .hero {
            height: 100vh;
            width: 100%;
            background: #f8fafc;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: stretch;
        }

        .hero::before {
            content: "";
            position: absolute;
            inset: 0;
            background-image:
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 20px 30px;
            -webkit-mask-image: radial-gradient(ellipse 70% 60% at 50% 0%, #000 60%, transparent 100%);
            mask-image: radial-gradient(ellipse 70% 60% at 50% 0%, #000 60%, transparent 100%);
            z-index: 0;
        }

        .content {
            position: relative;
            z-index: 10;
            max-width: 64rem;
            margin: 0 auto;
            padding: 1rem 1.5rem;
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }

        .chat-container {
            width: 100%;
            max-width: 56rem;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(229, 231, 235, 0.5);
            overflow: hidden;
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.8s ease-out forwards;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        @keyframes slideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .chat-header {
            background: linear-gradient(to right, #0f172a, #1e293b);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(229, 231, 235, 0.2);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .bot-avatar {
            width: 3rem;
            height: 3rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(8px);
        }

        .bot-icon {
            width: 1.5rem;
            height: 1.5rem;
            color: white;
        }

        .header-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            margin: 0;
            text-align: left;
        }

        .header-text p {
            color: #cbd5e1;
            font-size: 0.875rem;
            margin: 0;
            text-align: left;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 0.75rem;
            height: 0.75rem;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            color: #cbd5e1;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            background: linear-gradient(to bottom, rgba(249, 250, 251, 0.5), rgba(255, 255, 255, 0.5));
            min-height: 0;
        }

        .messages-container::-webkit-scrollbar {
            width: 6px;
        }

        .messages-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .messages-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 85%;
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            animation: messageSlideIn 0.3s ease-out forwards;
        }

        @keyframes messageSlideIn {
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #0f172a;
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #00a3d0, #0087b3);
            color: white;
        }

        .avatar-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        .message-bubble {
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid;
        }

        .message.user .message-bubble {
            background: #0f172a;
            color: white;
            border-color: #1e293b;
        }

        .message.assistant .message-bubble {
            background: white;
            color: #1f2937;
            border-color: #e5e7eb;
        }

        .message-content {
            font-size: 0.875rem;
            line-height: 1.5;
            margin: 0;
        }

        .message-time {
            font-size: 0.75rem;
            margin-top: 0.5rem;
        }

        .message.user .message-time {
            color: #cbd5e1;
        }

        .message.assistant .message-time {
            color: #6b7280;
        }

        .audio-message {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .audio-play-button {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .message.user .audio-play-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .message.user .audio-play-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .message.assistant .audio-play-button {
            background: #f3f4f6;
            color: #6b7280;
        }

        .message.assistant .audio-play-button:hover {
            background: #e5e7eb;
        }

        .audio-icon {
            width: 1rem;
            height: 1rem;
        }

        .audio-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .typing-indicator {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            opacity: 0;
            transform: translateY(20px);
            animation: messageSlideIn 0.3s ease-out forwards;
        }

        .typing-avatar {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 1rem;
            background: linear-gradient(135deg, #00a3d0, #0087b3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .typing-bubble {
            background: white;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-spinner {
            width: 1rem;
            height: 1rem;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .typing-text {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .input-area {
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border-top: 1px solid rgba(229, 231, 235, 0.5);
        }

        .input-container {
            display: flex;
            align-items: flex-end;
            gap: 1rem;
        }

        .text-input-container {
            flex: 1;
            position: relative;
        }

        .text-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            border: 1px solid #d1d5db;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            color: #1f2937;
            font-size: 0.875rem;
            resize: none;
            min-height: 48px;
            max-height: 120px;
            transition: all 0.2s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #00a3d0;
            box-shadow: 0 0 0 3px rgba(0, 163, 208, 0.1);
        }

        .text-input::placeholder {
            color: #6b7280;
        }

        .action-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-button {
            width: 3rem;
            height: 3rem;
            border-radius: 1rem;
            border: 1px solid;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            transform: scale(1);
        }

        .action-button:hover {
            transform: scale(1.05);
        }

        .action-button:active {
            transform: scale(0.95);
        }


        .record-button {
            border-color: #d1d5db;
            color: #6b7280;
        }

        .record-button.recording {
            background: #ef4444;
            border-color: #ef4444;
            color: white;
            animation: pulse 1s infinite;
        }

        .record-button:not(.recording) {
            background: #f3f4f6;
        }

        .record-button:not(.recording):hover {
            background: #e5e7eb;
        }

        .send-button {
            background: #0f172a;
            border-color: #0f172a;
            color: white;
        }

        .send-button:hover:not(:disabled) {
            background: #1e293b;
        }

        .send-button:disabled {
            background: #d1d5db;
            border-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .action-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        .recording-indicator {
            margin-top: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #ef4444;
            opacity: 0;
            transform: translateY(10px);
            animation: fadeSlideIn 0.3s ease-out forwards;
        }

        @keyframes fadeSlideIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .recording-dot {
            width: 0.5rem;
            height: 0.5rem;
            background: #ef4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .recording-text {
            font-size: 0.875rem;
            font-weight: 500;
        }

        .footer {
            margin-top: 0.5rem;
            text-align: center;
            opacity: 0;
            transform: translateY(20px);
            animation: slideIn 0.8s ease-out 0.2s forwards;
            flex-shrink: 0;
        }

        .footer-text {
            color: #64748b;
            font-size: 0.875rem;
        }

        .footer-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: 500;
        }

        .footer-link:hover {
            text-decoration: underline;
        }

        .hidden {
            display: none;
        }

        /* Upload status styles */

        /* Recording timer styles */
        .recording-timer {
            font-size: 0.75rem;
            color: #ef4444;
            font-weight: 600;
            margin-right: 0.5rem;
            white-space: nowrap;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .content {
                padding: 0.5rem 1rem;
            }

            .chat-container {
                max-width: none;
                border-radius: 1rem;
            }

            .chat-header {
                padding: 1rem 1.5rem;
            }

            .header-text h1 {
                font-size: 1.25rem;
            }

            .header-text p {
                font-size: 0.8125rem;
            }

            .messages-container {
                padding: 1rem;
            }

            .message {
                max-width: 85%;
            }

            .input-area {
                padding: 1rem;
            }

            .input-container {
                gap: 0.75rem;
            }

            .action-button {
                width: 2.5rem;
                height: 2.5rem;
            }

        }

        @media (max-width: 480px) {
            .content {
                padding: 0.5rem;
            }

            .chat-header {
                padding: 0.75rem 1rem;
            }

            .header-left {
                gap: 0.75rem;
            }

            .bot-avatar {
                width: 2.5rem;
                height: 2.5rem;
            }

            .header-text h1 {
                font-size: 1.125rem;
            }

            .messages-container {
                padding: 0.75rem;
                gap: 1rem;
            }

            .message {
                max-width: 90%;
            }

            .message-bubble {
                padding: 0.625rem 0.875rem;
            }

            .input-area {
                padding: 0.75rem;
            }

            .action-button {
                width: 2.25rem;
                height: 2.25rem;
            }

            .action-icon {
                width: 1rem;
                height: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="hero">
        <div class="content">
            <div class="chat-container">
                <!-- Header -->
                <div class="chat-header">
                    <div class="header-content">
                        <div class="header-left">
                            <div class="bot-avatar">
                                <svg class="bot-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                                </svg>
                            </div>
                            <div class="header-text">
                                <h1>Chatbot Iarvix</h1>
                                <p>Dinos que hace tu empresa y te decimos como optimizar</p>
                            </div>
                        </div>
                        <div class="status-indicator">
                            <div class="status-dot"></div>
                            <span class="status-text">En línea</span>
                        </div>
                    </div>
                </div>

                <!-- Messages Container -->
                <div id="messages-container" class="messages-container">
                    <div class="message assistant">
                        <div class="message-avatar">
                            <svg class="avatar-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="message-bubble">
                            <p class="message-content">¡Hola! Soy tu asistente de IA. ¿En qué puedo ayudarte hoy? Puedes escribir tu mensaje o subir un archivo de audio.</p>
                            <div class="message-time">
                                <script>document.write(new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'}))</script>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="input-area">

                    <div class="input-container">
                        <!-- Text Input -->
                        <div class="text-input-container">
                            <textarea 
                                id="text-input" 
                                class="text-input" 
                                placeholder="Escribe tu mensaje aquí..." 
                                rows="1"
                                maxlength="500"></textarea>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <!-- Voice Recording -->
                            <span id="recording-timer" class="recording-timer hidden">0:00</span>
                            <button id="record-button" class="action-button record-button" title="Grabar mensaje de voz">
                                <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                                </svg>
                            </button>

                            <!-- Send Button -->
                            <button id="send-button" class="action-button send-button" title="Enviar mensaje" disabled>
                                <svg class="action-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Recording Indicator -->
                    <div id="recording-indicator" class="recording-indicator hidden">
                        <div class="recording-dot"></div>
                        <span class="recording-text">Grabando... Haz clic en el botón rojo para enviar</span>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="footer">
                <p class="footer-text">
                    © 2025 IARVIX. Construido por 
                    <a href="https://www.linkedin.com/in/automatizacion-para-empresas/" target="_blank" class="footer-link">Jose Andonaire</a> y 
                    <a href="https://www.linkedin.com/in/javiercabreraleon/" target="_blank" class="footer-link">Javier Cabrera</a>
                </p>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const messagesContainer = document.getElementById('messages-container');
        const textInput = document.getElementById('text-input');
        const sendButton = document.getElementById('send-button');
        const recordButton = document.getElementById('record-button');
        const recordingTimer = document.getElementById('recording-timer');
        const recordingIndicator = document.getElementById('recording-indicator');

        // Webhook URL
        const originalWebhookUrl = 'https://n8n.srv942015.hstgr.cloud/webhook/consultor';

        // State management
        let isProcessing = false;
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingTimerInterval = null;
        let recordingStartTime = null;
        let audioPlaying = null;
        const MAX_RECORDING_TIME = 60; // 60 seconds max

        // Initialize
        sendButton.disabled = true;

        // Event Listeners
        textInput.addEventListener('input', handleInputChange);
        textInput.addEventListener('keypress', handleKeyPress);
        sendButton.addEventListener('click', () => sendMessage(textInput.value.trim()));
        recordButton.addEventListener('click', handleRecordToggle);

        // Functions
        function handleInputChange() {
            const hasText = textInput.value.trim().length > 0;
            sendButton.disabled = !hasText || isProcessing;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (textInput.value.trim() && !isProcessing) {
                    sendMessage(textInput.value.trim());
                }
            }
        }

        function sendMessage(content, isAudioMessage = false, audioUrl = null) {
            if (!content.trim() && !isAudioMessage) return;

            // Add user message
            addMessage(content, 'user', isAudioMessage, audioUrl);
            
            // Clear input and update UI
            textInput.value = '';
            handleInputChange();
            textInput.disabled = true;
            sendButton.disabled = true;
            isProcessing = true;

            // Show typing indicator
            showTypingIndicator();

            // Send to webhook
            const payload = isAudioMessage ? 
                createAudioFormData(audioUrl) : 
                JSON.stringify({ text: content });
            
            const headers = isAudioMessage ? {} : { 'Content-Type': 'application/json' };
            
            sendToWebhook(originalWebhookUrl, payload, headers);
        }

        function createAudioFormData(audioUrl) {
            // Convert audio URL to blob and create FormData
            fetch(audioUrl)
                .then(response => response.blob())
                .then(blob => {
                    const formData = new FormData();
                    const timestamp = Date.now();
                    const fileName = `audio_${timestamp}.webm`;
                    formData.append('file', blob, fileName);
                    return formData;
                })
                .catch(error => console.error('Error creating audio FormData:', error));
        }

        function addMessage(content, sender, isAudio = false, audioUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar';
            
            const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            iconSvg.setAttribute('class', 'avatar-icon');
            iconSvg.setAttribute('fill', 'none');
            iconSvg.setAttribute('stroke', 'currentColor');
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            
            if (sender === 'user') {
                iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>';
            } else {
                iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>';
            }
            
            avatarDiv.appendChild(iconSvg);
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';
            
            if (isAudio && audioUrl) {
                const audioDiv = document.createElement('div');
                audioDiv.className = 'audio-message';
                
                const playButton = document.createElement('button');
                playButton.className = 'audio-play-button';
                playButton.onclick = () => toggleAudioPlayback(messageDiv, audioUrl);
                
                const playIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                playIcon.setAttribute('class', 'audio-icon');
                playIcon.setAttribute('fill', 'none');
                playIcon.setAttribute('stroke', 'currentColor');
                playIcon.setAttribute('viewBox', '0 0 24 24');
                playIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 14.142M9 9v6l6-3-6-3z"></path>';
                
                playButton.appendChild(playIcon);
                
                const audioText = document.createElement('span');
                audioText.className = 'audio-text';
                audioText.textContent = content;
                
                audioDiv.appendChild(playButton);
                audioDiv.appendChild(audioText);
                bubbleDiv.appendChild(audioDiv);
            } else {
                const contentP = document.createElement('p');
                contentP.className = 'message-content';
                contentP.innerHTML = linkifyText(content);
                bubbleDiv.appendChild(contentP);
            }
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            bubbleDiv.appendChild(timeDiv);
            
            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(bubbleDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'typing-avatar';
            
            const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            iconSvg.setAttribute('class', 'avatar-icon');
            iconSvg.setAttribute('fill', 'none');
            iconSvg.setAttribute('stroke', 'currentColor');
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            iconSvg.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>';
            avatarDiv.appendChild(iconSvg);
            
            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'typing-bubble';
            
            const spinner = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            spinner.setAttribute('class', 'loading-spinner');
            spinner.setAttribute('fill', 'none');
            spinner.setAttribute('stroke', 'currentColor');
            spinner.setAttribute('viewBox', '0 0 24 24');
            spinner.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>';
            
            const typingText = document.createElement('span');
            typingText.className = 'typing-text';
            typingText.textContent = 'Escribiendo...';
            
            bubbleDiv.appendChild(spinner);
            bubbleDiv.appendChild(typingText);
            
            typingDiv.appendChild(avatarDiv);
            typingDiv.appendChild(bubbleDiv);
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function sendToWebhook(url, body, headers = {}) {
            console.log('Sending to webhook:', url);
            
            fetch(url, {
                method: 'POST',
                headers: headers,
                body: body
            })
            .then(response => {
                console.log('Response received:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Error response:', text);
                        throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                    });
                }
                return response.text();
            })
            .then(data => {
                console.log('Response data:', data);
                removeTypingIndicator();
                
                try {
                    const jsonResponse = JSON.parse(data);
                    let messageToShow = '';
                    
                    if (jsonResponse.output) {
                        messageToShow = jsonResponse.output;
                    } else if (jsonResponse.message) {
                        messageToShow = jsonResponse.message;
                    } else if (jsonResponse.text) {
                        messageToShow = jsonResponse.text;
                    } else if (typeof jsonResponse === 'string') {
                        messageToShow = jsonResponse;
                    } else {
                        messageToShow = JSON.stringify(jsonResponse);
                    }
                    
                    addMessage(messageToShow, 'assistant');
                    
                } catch (e) {
                    console.log('Not JSON, treating as plain text:', e);
                    addMessage(data || 'Respuesta recibida', 'assistant');
                }
            })
            .catch(error => {
                console.error('Fetch error:', error);
                removeTypingIndicator();
                addMessage("Lo siento, hubo un error al procesar tu consulta. Error: " + error.message, 'assistant');
            })
            .finally(() => {
                console.log('Request completed, re-enabling controls');
                isProcessing = false;
                textInput.disabled = false;
                handleInputChange();
            });
        }

        function linkifyText(text) {
            const textWithBreaks = text.replace(/\\n/g, '<br>').replace(/\n/g, '<br>');
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            return textWithBreaks.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener noreferrer" style="color: inherit; text-decoration: underline;">$1</a>');
        }

        function toggleAudioPlayback(messageElement, audioUrl) {
            if (audioPlaying === messageElement) {
                audioPlaying = null;
                // Update icon to play state
            } else {
                audioPlaying = messageElement;
                const audio = new Audio(audioUrl);
                audio.play();
                audio.onended = () => {
                    audioPlaying = null;
                    // Update icon back to play state
                };
            }
        }

        // Voice Recording Functions
        async function handleRecordToggle() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }

        async function startRecording() {
            if (isProcessing || isRecording) {
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });

                // Detect supported audio type
                let mimeType = 'audio/webm';
                if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                    mimeType = 'audio/webm;codecs=opus';
                } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                    mimeType = 'audio/mp4';
                } else if (MediaRecorder.isTypeSupported('audio/wav')) {
                    mimeType = 'audio/wav';
                }

                mediaRecorder = new MediaRecorder(stream, { mimeType });
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    uploadAudio(audioBlob, mimeType);
                    
                    // Clean up stream
                    stream.getTracks().forEach(track => track.stop());
                };

                // Setup UI
                isRecording = true;
                recordingStartTime = Date.now();
                
                recordButton.classList.add('recording');
                recordButton.title = 'Detener grabación';
                recordingTimer.classList.remove('hidden');
                recordingIndicator.classList.remove('hidden');
                
                // Change icon to stop/send triangle
                const recordIcon = recordButton.querySelector('.action-icon');
                recordIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5l8 7-8 7V5z"></path>';
                
                // Disable other controls
                textInput.disabled = true;
                sendButton.disabled = true;

                // Start recording
                mediaRecorder.start(100); // Collect data every 100ms
                
                // Start timer
                updateRecordingTimer();
                recordingTimerInterval = setInterval(updateRecordingTimer, 1000);

                console.log('Recording started');

            } catch (error) {
                console.error('Error accessing microphone:', error);
                let errorMessage = 'Error al acceder al micrófono.';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Permiso de micrófono denegado. Por favor, permite el acceso al micrófono.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No se encontró micrófono. Verifica que tienes un micrófono conectado.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'Grabación de audio no soportada en este navegador.';
                }
                
                addMessage(errorMessage, 'assistant');
                resetRecordingState();
            }
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) {
                return;
            }

            console.log('Stopping recording...');
            
            // Stop recording
            mediaRecorder.stop();
            
            // Clean timer
            clearInterval(recordingTimerInterval);
            recordingTimerInterval = null;
            
            // Update UI
            recordButton.classList.remove('recording');
            recordButton.title = 'Procesando audio...';
            recordButton.disabled = true;
            recordingTimer.classList.add('hidden');
            recordingIndicator.classList.add('hidden');
            
            isRecording = false;
        }

        function updateRecordingTimer() {
            if (!isRecording) return;
            
            const recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);
            
            const minutes = Math.floor(recordingDuration / 60);
            const seconds = recordingDuration % 60;
            recordingTimer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Auto-stop after max time
            if (recordingDuration >= MAX_RECORDING_TIME) {
                stopRecording();
                addMessage(`Grabación detenida automáticamente después de ${MAX_RECORDING_TIME} segundos.`, 'assistant');
            }
        }

        function uploadAudio(audioBlob, mimeType) {
            console.log('Uploading audio with blob size:', audioBlob.size);
            
            // Set processing state
            isProcessing = true;
            textInput.disabled = true;
            sendButton.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            // Generate filename
            const timestamp = Date.now();
            const extension = mimeType.includes('webm') ? 'webm' : 
                             mimeType.includes('mp4') ? 'mp4' : 'wav';
            const fileName = `audio_${timestamp}.${extension}`;
            
            const recordingDuration = Math.floor((Date.now() - recordingStartTime) / 1000);

            // Convertir audioBlob a Base64
            convertBlobToBase64(audioBlob)
                .then(base64Data => {
                    const payload = JSON.stringify({
                        audio: base64Data,
                        filename: fileName,
                        mimeType: mimeType,
                        duration: recordingDuration,
                        type: 'audio'
                    });

                    console.log('Sending audio as Base64 to webhook:', originalWebhookUrl);

                    return fetch(originalWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: payload
                    });
                })
                .then(response => {
                    console.log('Audio upload response:', response.status);
                    
                    if (!response.ok) {
                        const errorMessage = `✗ Error al enviar audio (Servidor respondió: ${response.status}).`;
                        addMessage(errorMessage, 'assistant');
                        return response.text().then(text => {
                            console.error('Audio upload error response:', text);
                            throw new Error(`Audio upload HTTP error! status: ${response.status}, body: ${text}`);
                        });
                    }
                    
                    console.log('Audio upload successful');
                    addMessage(`✓ Audio enviado correctamente (${recordingDuration}s).`, 'user');
                    
                    return response.text();
                })
                .then(data => {
                    console.log('Audio upload response data:', data);
                    removeTypingIndicator();
                    
                    try {
                        const jsonResponse = JSON.parse(data);
                        let messageToShow = '';
                        
                        if (jsonResponse.output) {
                            messageToShow = jsonResponse.output;
                        } else if (jsonResponse.message) {
                            messageToShow = jsonResponse.message;
                        } else if (jsonResponse.text) {
                            messageToShow = jsonResponse.text;
                        } else if (typeof jsonResponse === 'string') {
                            messageToShow = jsonResponse;
                        } else {
                            messageToShow = JSON.stringify(jsonResponse);
                        }
                        
                        if (messageToShow) {
                            addMessage(messageToShow, 'assistant');
                        }
                        
                    } catch (e) {
                        console.log('Audio response not valid JSON:', e);
                        if (data && data.trim()) {
                            addMessage(data, 'assistant');
                        }
                    }
                })
                .catch(error => {
                    console.error('Audio upload error:', error);
                    removeTypingIndicator();
                    const connErrorMessage = `✗ Error de conexión al enviar audio. Error: ${error.message}`;
                    addMessage(connErrorMessage, 'assistant');
                })
                .finally(() => {
                    console.log('Audio request completed, re-enabling controls');
                    isProcessing = false;
                    textInput.disabled = false;
                    handleInputChange();
                    resetRecordingState();
                });
        }

        // Función auxiliar para convertir Blob a Base64
        function convertBlobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    // Remover el prefijo "data:audio/webm;base64," para obtener solo el Base64
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }


        function resetRecordingState() {
            isRecording = false;
            recordingStartTime = null;
            
            // Clean timer
            if (recordingTimerInterval) {
                clearInterval(recordingTimerInterval);
                recordingTimerInterval = null;
            }
            
            // Reset UI
            recordButton.classList.remove('recording');
            recordButton.title = 'Grabar mensaje de voz';
            recordButton.disabled = false;
            recordingTimer.classList.add('hidden');
            recordingTimer.textContent = '0:00';
            recordingIndicator.classList.add('hidden');
            
            // Reset icon back to microphone
            const recordIcon = recordButton.querySelector('.action-icon');
            recordIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>';
            
            // Re-enable other controls
            textInput.disabled = false;
            
            handleInputChange();
        }

    </script>
</body>
</html>